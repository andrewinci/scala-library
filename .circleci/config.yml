version: 2.1

orbs:
  snyk: snyk/snyk@0.0.13

jobs:
  build:
    docker:
      - image: circleci/openjdk:11-jdk
    parameters:
      publish:
        type: boolean
        default: false
    working_directory: ~/repo
    environment:
      JVM_OPTS: -Xmx3200m
      TERM: dumb
    steps:
      - checkout
      - restore_cache:
          keys:
            - v2-dependencies-{{ checksum "build.sbt" }}
            - v1-dependencies-
      - run:
          name: Run tests
          command: sbt clean coverage test
      - when:
          condition: << parameters.publish >>
          steps:
            - run:
                name: Publish
                command: sbt "set version := \"${CIRCLE_TAG}\"" publish
      # Add the env COVERALLS_REPO_TOKEN=my-token to the circleci build env
      # to enable code coverage reporting
      #      - run:
      #          name: Collect coverage
      #          command: sbt coverageReport coveralls
      - save_cache:
          paths:
            - ~/.sbt
          key: v2-dependencies-{{ checksum "build.sbt" }}
      # Add SNYK_TOKEN in circle ci to enable the scan
      #      - snyk/scan:
      #          severity-threshold: high

workflows:
  version: 2
  build:
    jobs:
      - build:
          name: CI
          publish: false
          filters:
            tags:
              ignore: /.*/
      - build:
          name: Release
          publish: true
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^\d+\.\d+\.\d+$/
